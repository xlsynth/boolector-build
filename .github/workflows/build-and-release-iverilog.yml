name: Build and Release Icarus Verilog

# ←‑‑ give the default GITHUB_TOKEN write access to repository contents
permissions:
  contents: write
  packages: read

on:
  workflow_dispatch:
    inputs:
      iverilog_ref:
        description: 'Icarus Verilog git ref to build (branch, tag, or SHA)'
        required: false
        default: ea26587b5ef485f2ca82a3e4364e58ec3307240f

env:
  IVERILOG_REF: ${{ inputs.iverilog_ref || 'ea26587b5ef485f2ca82a3e4364e58ec3307240f' }}

jobs:
  iverilog-build:
    runs-on: ubuntu-latest
    container: rockylinux:8

    steps:
      - uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          dnf -y upgrade --refresh
          dnf -y install dnf-plugins-core
          dnf config-manager --set-enabled powertools || true
          dnf -y groupinstall "Development Tools"
          dnf -y install \
            git autoconf automake bison flex gperf readline-devel \
            ca-certificates curl m4

      - name: Clone and build Icarus Verilog
        run: |
          git clone https://github.com/steveicarus/iverilog
          cd iverilog
          echo "Using Icarus Verilog ref: $IVERILOG_REF"
          git checkout --detach "$IVERILOG_REF"
          sh autoconf.sh
          ./configure --prefix=/usr/local
          make -j"$(nproc)"
          make install DESTDIR="$GITHUB_WORKSPACE/iverilog-install"

      - name: Prepare artifact directory
        run: |
          mkdir -p rocky8-artifacts
          cp iverilog/COPYING rocky8-artifacts/
          cp iverilog-install/usr/local/bin/iverilog rocky8-artifacts/iverilog-rocky8
          cp iverilog-install/usr/local/bin/vvp rocky8-artifacts/vvp-rocky8
          sha256sum rocky8-artifacts/iverilog-rocky8 > rocky8-artifacts/iverilog-rocky8.sha256
          sha256sum rocky8-artifacts/vvp-rocky8 > rocky8-artifacts/vvp-rocky8.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: iverilog-rocky8
          path: rocky8-artifacts/

  

  iverilog-release:
    needs: [iverilog-build]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: iverilog-rocky8
          path: iverilog-rocky8

      - name: List downloaded files
        run: |
          echo "--- Rocky Linux 8 artifacts ---"
          ls -lR iverilog-rocky8

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: iverilog-binaries-${{ env.IVERILOG_REF }}
        run: |
          gh release create "$TAG_NAME" \
            iverilog-rocky8/iverilog-rocky8 \
            iverilog-rocky8/iverilog-rocky8.sha256 \
            iverilog-rocky8/vvp-rocky8 \
            iverilog-rocky8/vvp-rocky8.sha256 \
            iverilog-rocky8/COPYING \
            --title "Release $TAG_NAME" \
            --notes "Automated release of $TAG_NAME. Includes Rocky Linux 8 (x86_64) Icarus Verilog binaries (iverilog and vvp)."


